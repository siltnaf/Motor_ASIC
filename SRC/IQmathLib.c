/*
 * lib.c
 *	Copy Right (c) of JE
 *  Created on: 
 *      18 Sep 2018
 *  Author: 
 *      Ken
 *  Last Modified: 
 *     
 *  Description: 
 *      lib for JE8MCU
 *  History:
 *      ver 0.1 created by ken on 12 August 2016 
 *
 *		Use math table for fuctions of 
 *				sin, cos, inverse, sqrt, artan
 *				Polar transform
 *
 *
 */
 
 /***************************************************
 * Includes
 */

#include <intrins.h>   
#include <absacc.h>
#include "register.h"
#include "IQmathLib.h"



 Long_Data dat;
 _iq data X,Y,Z;

 S8  data index;

 unsigned int code PolarTable[512]=
 {
		0,17,35,53,71,89,107,125,143,161,179,198,216,235,253,272,291,309,328,347,366,385,404,423,443,462,481,501,520,540,560,579,
		599,619,639,659,679,699,719,739,760,780,800,821,841,862,883,903,924,945,966,987,1008,1029,1050,1071,1093,1114,1135,1157,1178,1200,1221,1243,
		1265,1286,1308,1330,1352,1374,1396,1418,1440,1462,1484,1506,1529,1551,1573,1596,1618,1641,1663,1686,1708,1731,1754,1776,1799,1822,1845,1868,1891,1914,1937,1960,
		1983,2006,2029,2052,2075,2098,2121,2145,2168,2191,2214,2238,2261,2284,2308,2331,2354,2378,2401,2425,2448,2472,2495,2519,2542,2566,2589,2613,2636,2660,2683,2707,
		2730,2754,2777,2801,2824,2848,2871,2895,2918,2942,2965,2989,3012,3036,3059,3082,3106,3129,3153,3176,3199,3223,3246,3269,3293,3316,3339,3362,3385,3408,3432,3455,
		3478,3501,3524,3547,3570,3593,3615,3638,3661,3684,3707,3729,3752,3775,3797,3820,3842,3865,3887,3909,3932,3954,3976,3998,4020,4043,4065,4087,4109,4130,4152,4174,
		4196,4218,4239,4261,4282,4304,4325,4347,4368,4389,4410,4431,4452,4473,4494,4515,4536,4557,4578,4598,4619,4640,4660,4680,4701,4721,4741,4761,4782,4802,4822,4841,
		4861,4881,4901,4920,4940,4960,4979,4998,5018,5037,5056,5075,5094,5113,5132,5151,5170,5188,5207,5226,5244,5263,5281,5299,5317,5336,5354,5372,5390,5408,5425,5443,
		5461,5478,5496,5513,5531,5548,5565,5583,5600,5617,5634,5651,5668,5684,5701,5718,5734,5751,5767,5784,5800,5816,5832,5848,5864,5880,5896,5912,5928,5944,5959,5975,
		5990,6006,6021,6036,6052,6067,6082,6097,6112,6127,6142,6157,6171,6186,6200,6215,6229,6244,6258,6272,6287,6301,6315,6329,6343,6357,6371,6384,6398,6412,6425,6439,
		6452,6466,6479,6492,6506,6519,6532,6545,6558,6571,6584,6597,6609,6622,6635,6647,6660,6672,6685,6697,6710,6722,6734,6746,6758,6770,6782,6794,6806,6818,6830,6841,
		6853,6865,6876,6888,6899,6911,6922,6933,6945,6956,6967,6978,6989,7000,7011,7022,7033,7044,7054,7065,7076,7086,7097,7107,7118,7128,7139,7149,7159,7170,7180,7190,
		7200,7210,7220,7230,7240,7250,7260,7269,7279,7289,7299,7308,7318,7327,7337,7346,7356,7365,7374,7384,7393,7402,7411,7420,7429,7439,7448,7456,7465,7474,7483,7492,
		7501,7509,7518,7527,7535,7544,7553,7561,7570,7578,7586,7595,7603,7611,7620,7628,7636,7644,7652,7660,7668,7676,7684,7692,7700,7708,7716,7724,7732,7739,7747,7755,
		7762,7770,7778,7785,7793,7800,7808,7815,7822,7830,7837,7844,7852,7859,7866,7873,7880,7888,7895,7902,7909,7916,7923,7930,7937,7943,7950,7957,7964,7971,7977,7984,
		7991,7998,8004,8011,8017,8024,8030,8037,8043,8050,8056,8063,8069,8075,8082,8088,8094,8101,8107,8113,8119,8125,8132,8138,8144,8150,8156,8162,8168,8174,8180,8186
 };

unsigned int code MagnitudeTable[512]=
	
{
		16384,16320,16257,16194,16132,16070,16009,15948,15888,15828,15769,15710,15652,15594,15537,15480,15424,15368,15313,15258,15204,15150,15097,15044,14992,14940,14889,14838,14788,14738,14689,14640,
		14592,14544,14497,14450,14404,14358,14313,14268,14224,14180,14137,14094,14052,14010,13969,13928,13888,13848,13809,13770,13732,13694,13657,13620,13584,13548,13513,13478,13444,13410,13377,13344,
		13312,13280,13249,13218,13188,13158,13129,13100,13072,13044,13017,12990,12964,12938,12913,12888,12864,12840,12817,12794,12772,12750,12729,12708,12688,12668,12649,12630,12612,12594,12577,12560,
		12544,12528,12513,12498,12484,12470,12457,12444,12432,12420,12409,12398,12388,12378,12369,12360,12352,12344,12337,12330,12324,12318,12313,12308,12304,12300,12297,12294,12292,12290,12289,12288,
		12288,12288,12289,12290,12292,12294,12297,12300,12304,12308,12313,12318,12324,12330,12337,12344,12352,12360,12369,12378,12388,12398,12409,12420,12432,12444,12457,12470,12484,12498,12513,12528,
		12544,12560,12577,12594,12612,12630,12649,12668,12688,12708,12729,12750,12772,12794,12817,12840,12864,12888,12913,12938,12964,12990,13017,13044,13072,13100,13129,13158,13188,13218,13249,13280,
		13312,13344,13377,13410,13444,13478,13513,13548,13584,13620,13657,13694,13732,13770,13809,13848,13888,13928,13969,14010,14052,14094,14137,14180,14224,14268,14313,14358,14404,14450,14497,14544,
		14592,14640,14689,14738,14788,14838,14889,14940,14992,15044,15097,15150,15204,15258,15313,15368,15424,15480,15537,15594,15652,15710,15769,15828,15888,15948,16009,16070,16132,16194,16257,16320,
		16384,16448,16513,16578,16644,16710,16777,16844,16912,16980,17049,17118,17188,17258,17329,17400,17472,17544,17617,17690,17764,17838,17913,17988,18064,18140,18217,18294,18372,18450,18529,18608,
		18688,18768,18849,18930,19012,19094,19177,19260,19344,19428,19513,19598,19684,19770,19857,19944,20032,20120,20209,20298,20388,20478,20569,20660,20752,20844,20937,21030,21124,21218,21313,21408,
		21504,21600,21697,21794,21892,21990,22089,22188,22288,22388,22489,22590,22692,22794,22897,23000,23104,23208,23313,23418,23524,23630,23737,23844,23952,24060,24169,24278,24388,24498,24609,24720,
		24832,24944,25057,25170,25284,25398,25513,25628,25744,25860,25977,26094,26212,26330,26449,26568,26688,26808,26929,27050,27172,27294,27417,27540,27664,27788,27913,28038,28164,28290,28417,28544,
		28672,28800,28929,29058,29188,29318,29449,29580,29712,29844,29977,30110,30244,30378,30513,30648,30784,30920,31057,31194,31332,31470,31609,31748,31888,32028,32169,32310,32452,32594,32737,32880,
		33024,33168,33313,33458,33604,33750,33897,34044,34192,34340,34489,34638,34788,34938,35089,35240,35392,35544,35697,35850,36004,36158,36313,36468,36624,36780,36937,37094,37252,37410,37569,37728,
		37888,38048,38209,38370,38532,38694,38857,39020,39184,39348,39513,39678,39844,40010,40177,40344,40512,40680,40849,41018,41188,41358,41529,41700,41872,42044,42217,42390,42564,42738,42913,43088,
		43264,43440,43617,43794,43972,44150,44329,44508,44688,44868,45049,45230,45412,45594,45777,45960,46144,46328,46513,46698,46884,47070,47257,47444,47632,47820,48009,48198,48388,48578,48769,48960,

	
};




//_iq Normalize(_iq A)              //normalize only work for positive value. it return error if the MD3_7=1 
//{


//	

// dat.Ldata =A;
// MD0 = dat.ss1.Byte0;
// MD1 = dat.ss1.Byte1;
// MD2 = dat.ss1.Byte2;
// MD3 = dat.ss1.Byte3;
//	

//	
// ARCON = 0x00 ; // Start Normalizing
// while(MD3_7==0 ); //check MDU finish flag
//	dat.ss1.Byte0=MD0;
//	dat.ss1.Byte1=MD1;
//	dat.ss1.Byte2=MD2;
//	dat.ss1.Byte3=MD3;
// 
//	 return dat.Ldata ;
//}



/*
 * @fn		mul32
 *
 * @brief	mul32
 * 
* @param	none
 * _IQmul(X,Y) ,  = X*Y

 *
 * @return 	value in IQ
 */

_iq _IQmul(_iq A , _iq B) 
{
	

	X=_IQint(A);
	Y=_IQint(B);
	Z=BarrelShift((X*Y), (LA_shift+ GLOBAL_Q));
	X=X*_IQfrac(B);
	Y=Y*_IQfrac(A);
	Z=Z+X+Y+BarrelShift((_IQfrac(B)*_IQfrac(A)), (RA_shift+ GLOBAL_Q));


	
	
	
	return Z;


}





/*
 * @fn		sin32
 *
 * @brief	sin32
 * 
* @param	none
 * _IQsin(X) ,  =sin(X), X is in degree

 *
 * @return 	value in IQ
 */







_iq _IQsin(_iq A)
{

	X=_IQabs(A);
	
		
	//limtit the search anlge to <360)
	
  while (X>=_IQ(360.0))
			{
				X-=_IQ(360.0);
			}
	
	
	// convert angle to data in sin table, angle =angle/360 * 512  or  =angle *64/45
			
	X=_IQmul(X,_IQ(1.422222));
  X=_IQint(X);          //convert to integer
  Z=XWORD[X+sin_table];
	Z=BarrelShift(Z,(LL_shift+16));   										//sin table is in Q15 format, it need to convert to Q31 first by shifting 16 bit to left
	Z=BarrelShift(Z, (RA_shift+ (30 - GLOBAL_Q)));     	//convert Q31 to global Q format

	if (A<0) Z=-(Z);

return Z ;
	
}









/*
 * @fn		sqrt32
 *
 * @brief	sqrt32
 * 
 * @param	none
 * _IQsqrt(X) ,  sqrt(X)

 *
 * @return 	sqrt value in IQ
 */






_iq _IQsqrt(_iq A)

{

	if (A<0) return 0;

	X=Normalize(A);   //convert to Q30 format
	index=(31-GLOBAL_Q-ARCON);
	
	if (index %2==0)                //check if the power is even or  odd value	
	{
	X &=0x7fffffff;
	X=BarrelShift(X, (RA_shift+23))+128;	
		
		Z=XWORD[X+sqrt_table];
	}
	else
	{
    index++;                             //if the power is odd value , divide t by 2
	
		X =BarrelShift(X,(RA_shift+24));             //square root in value is divided by 2 
	  X &=0x0000007f;
		Z=XWORD[X+sqrt_table];
	}
	Z=BarrelShift(Z,(LL_shift+16));   										//sqrt table is in Q15 format, it need to convert to Q31 first by shifting 16 bit to left
	Z=BarrelShift(Z, (RA_shift+ (30 - GLOBAL_Q)));     	//convert Q31 to global Q format
	

	
	if (index>=0)
	Z=BarrelShift(Z, (LA_shift+(index/2)));
	else Z=BarrelShift(Z,(RA_shift+((-index)/2)));
	
return  Z;
}


/*
 * @fn		atan32
 *
 * @brief	atan32
 * 
 * @param	none
 * _IQatan2(Y,X) ,  atan2(Y/X)
 * _IQatan(Y)    , =atan2(Y/1)
 *


 * @return 	angle in degree
 */

_iq _IQatan2(_iq A, _iq B)
{
	Y=_IQabs(A);
	X=_IQabs(B);

	
	if (X>Y)
		{
			
			
			
			Y=BarrelShift(Y,(LA_shift+5));  
			X=BarrelShift(X,(RA_shift+4));  
			X=Y/X;
		
		
			index=pos;
		
		 

		}
		else
		{
			X=BarrelShift(X,(LA_shift+5)); ;
			Y=BarrelShift(Y,(RA_shift+4)); 
			X=X/Y;

			
			index=neg;
		}
			
			
			
		Z=XWORD[X+atan_table];
		Z=Z*45;                 //Z=(Z/4096)*45 degree
		Z=BarrelShift(Z,(LL_shift+12));   										//sin table is in Q15 format, it need to convert to Q31 first by shifting 16 bit to left
		Z=BarrelShift(Z, (RA_shift+ (24 - GLOBAL_Q)));     	//convert Q31 to global Q format
		
		
		if (index==neg)	Z=_IQ(90.0)-Z;
		
	if ((A<0)&&(B>0))
		Z=_IQ(180.0)-Z;
		else if ((A<0)&&(B<0))
			Z=_IQ(180.0)+Z;
		else if ((A>0)&&(B<0))
			Z=_IQ(360.0)-Z;
	
	

return Z;	
}


_iq _IQmag(_iq A, _iq B) 
{
	X=_IQmul(A,A)+_IQmul(B,B);
	Z=_IQsqrt(X);
	return Z;
	
}



